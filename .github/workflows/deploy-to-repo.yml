name: Deploy to repository.silvo

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout addon source
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Extract addon metadata
        id: metadata
        run: |
          python3 << 'EOF'
          import xml.etree.ElementTree as ET
          import os

          tree = ET.parse('addon.xml')
          root = tree.getroot()

          addon_id = root.get('id')
          version = root.get('version')

          print(f"Addon: {addon_id}")
          print(f"Version: {version}")

          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"addon_id={addon_id}\n")
              f.write(f"version={version}\n")
          EOF

      - name: Package addon
        id: package
        run: |
          python3 << 'EOF'
          import zipfile
          import os
          from pathlib import Path

          addon_id = "${{ steps.metadata.outputs.addon_id }}"
          version = "${{ steps.metadata.outputs.version }}"
          zip_name = f"{addon_id}-{version}.zip"

          exclude_patterns = [
              # Git and CI
              '.git', '.github', ',github', '.gitignore', '.gitattributes',
              # Dev tools config
              '.claude', '.vscode', '.idea', '.sublime-',
              '.pylintrc', 'pyrightconfig.json', 'ruff.toml', 'pyproject.toml',
              # Caches
              '__pycache__', '.pyc', '.pyo', '.pyd',
              '.mypy_cache', '.ruff_cache', '.pytest_cache',
              # Dev folders
              'typings', 'tests', 'docs', 'DOCS',
              # Docs
              'README.md', 'CHANGELOG.md',
              # OS files
              '.DS_Store', 'Thumbs.db', 'desktop.ini',
              # Temp files
              '.log', '.tmp', '.bak', '.swp', '.swo'
          ]

          def should_exclude(path):
              path_str = str(path)
              for pattern in exclude_patterns:
                  if pattern in path_str:
                      return True
              return False

          print(f"Creating {zip_name}...")
          file_count = 0

          with zipfile.ZipFile(zip_name, 'w', zipfile.ZIP_DEFLATED) as zipf:
              for root, dirs, files in os.walk('.'):
                  dirs[:] = [d for d in dirs if not should_exclude(Path(root) / d)]

                  for file in files:
                      file_path = Path(root) / file

                      if should_exclude(file_path) or file == zip_name:
                          continue

                      arcname = Path(addon_id) / file_path.relative_to('.')
                      zipf.write(file_path, arcname)
                      file_count += 1

          size_mb = os.path.getsize(zip_name) / (1024 * 1024)
          print(f"Created {zip_name} ({file_count} files, {size_mb:.1f} MB)")

          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"zip_name={zip_name}\n")
          EOF

      - name: Clone repository.silvo
        run: |
          git clone https://x-access-token:${{ secrets.REPO_SILVO_PAT }}@github.com/MikeSiLVO/repository.silvo.git repo-silvo
          cd repo-silvo
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

      - name: Deploy to piers channel
        run: |
          ADDON_ID="${{ steps.metadata.outputs.addon_id }}"
          ZIP_NAME="${{ steps.package.outputs.zip_name }}"

          mkdir -p "repo-silvo/piers/${ADDON_ID}"

          cp "${ZIP_NAME}" "repo-silvo/piers/${ADDON_ID}/"
          echo "Copied ${ZIP_NAME}"

          for file in addon.xml changelog.txt; do
            if [ -f "$file" ]; then
              cp "$file" "repo-silvo/piers/${ADDON_ID}/"
              echo "Copied $file"
            fi
          done

          # Copy icon and fanart from resources path (skin uses nested assets)
          if [ -f "resources/icon.png" ]; then
            cp "resources/icon.png" "repo-silvo/piers/${ADDON_ID}/icon.png"
          elif [ -f "icon.png" ]; then
            cp "icon.png" "repo-silvo/piers/${ADDON_ID}/"
          fi

          if [ -f "resources/fanart.jpg" ]; then
            cp "resources/fanart.jpg" "repo-silvo/piers/${ADDON_ID}/fanart.jpg"
          elif [ -f "fanart.jpg" ]; then
            cp "fanart.jpg" "repo-silvo/piers/${ADDON_ID}/"
          fi

      - name: Generate repository metadata
        run: |
          cd repo-silvo
          python _repo_generator.py

      - name: Commit and push
        run: |
          cd repo-silvo
          git add .

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Deploy: ${{ steps.metadata.outputs.addon_id }} v${{ steps.metadata.outputs.version }}" \
                       -m "Source: ${{ github.repository }}@${{ github.sha }}" \
                       -m "Trigger: ${{ github.ref_name }}"
            git push
          fi

      - name: Summary
        run: |
          echo "## Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Addon | ${{ steps.metadata.outputs.addon_id }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ steps.metadata.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Channel | piers |" >> $GITHUB_STEP_SUMMARY
          echo "| Trigger | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
